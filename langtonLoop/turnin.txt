import Data.Array
import Data.Char
import Transition
import System.Console.ANSI
import Control.Concurrent

startLoop = ["022222222000000",
             "217014014200000",
             "202222220200000",
             "272000021200000",
             "212000021200000",
             "202000021200000",
             "272000021200000",
             "212222221222220",
             "207107107111112",
             "022222222222220"]

offset = 10
startLoopWidth = 15
startLoopHeight = 10
maxDim = 55

main = do
  let init = placeStartLoop $ array ((0, 0),(maxDim,maxDim)) [((x, y), '0') |
                                             x <- [0..maxDim], y <- [0..maxDim]]
  clearScreen
  updateLoop init 100000

updateLoop array numGens = do
  setCursorPosition 0 0
  let updated = update array
  printArray updated
  if numGens /= 0 then updateLoop updated (numGens - 1)
  else return ()
  

getRow n a =
  [a ! (n, c) | c <- [minCol..maxCol]] where ((_, minCol), (_, maxCol)) = bounds a

printRow n a = do print $ getRow n a

printArray a = do
  mapM_ (\x -> printRow x a) [minRow..maxRow] where ((minRow, _), (maxRow, _)) = bounds a
  
placeStartLoop a = a // changeList
  where changeList = [((x + offset, y + offset), (startLoop !! x) !! y) |
                    x <- [0..startLoopHeight-1], y <- [0..startLoopWidth-1]]

getFromArray (y,x) a =
  a ! (row, col) where
  row = y `mod` maxDim
  col = x `mod` maxDim
 
getTableEntry (x,y) a =
  getFromArray (x+0,y+0) a :
  getFromArray (x-1,y+0) a :
  getFromArray (x+0,y+1) a :
  getFromArray (x+1,y+0) a :
  getFromArray (x+0,y-1) a : []

update a =  a // changeList
  where changeList = [((x, y), getTransition (getTableEntry (x, y) a)) |
                       x <- [0..maxDim], y <- [0..maxDim]]


getTransition s =
  if transition s /= 'x' then transition s
  else
    getTransition $ (head s) : rotate (tail s)

rotate s = (drop 3 s) ++ (take 3 s)

transition "00000" = '0'
transition "00001" = '2'
.
.
.
transition _ = 'x'


"00000000002170170142027017017020000000000000000000000000"
"00000000002022222202021222222120000000000000000000000000"
"00000000002720000212021200002620000000000000000000000000"
"00000000002120000242021200002020000000000000000000000000"
"00000000002020000202021200002120000000000000000000000000"
"00000000002720000212021200002720000000000000000000000000"
"00000000002122222212020222222020000000000000000000000000"
"00000000002071071112024104107120000000000000000000000000"
"00000000000222222220002222222200000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"22222222000222222220002222252200022222222000222222220022"
"01701701202401111172020170170120217017017202014014012060"
"72222224202122222202027222222420212222220202722222212027"
"12000020202020000212021200002020212000021202120000212021"
"02000021202420000272020200002120212000027202020000212020"
"72000024202120000202027200002420212000020202720000212027"
"12000020205020000212021200002020202000021202120000272021"
"02222221202722222272020222222120242222227222122222202020"
"71071111202107107102027107111120210410710710010710712027"
"22222222000222222220002222222200022222222222222222220002"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000222222220000000000000000000000000000000000000"
"00000000002170170172000000000000000000000000000000000000"
"00000000002122222202000000000000000000000000000000000000"
"00000000002120000212000000000000000000000000000000000000"
"00000000002120000262000000000000000000000000000000000000"
"00000000002120000202000000000000000000000000000000000000"
"00000000002020000212000000000000000000000000000000000000"
"00000000002422222272000000000000000000000000000000000000"
"00000000002104107102000000000000000000000000000000000000"
"00000000000222222220000000000000000000000000000000000000"
"00000000000000000000000000000000000000000000000000000000"
"00000000000222222520002222222200000000000000000000000000"
"00000000002017017012021701701720000000000000000000000000"



